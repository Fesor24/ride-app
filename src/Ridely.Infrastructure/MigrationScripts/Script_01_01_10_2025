CREATE TABLE IF NOT EXISTS "__EFMigrationsHistory" (
    "MigrationId" character varying(150) NOT NULL,
    "ProductVersion" character varying(32) NOT NULL,
    CONSTRAINT "PK___EFMigrationsHistory" PRIMARY KEY ("MigrationId")
);

START TRANSACTION;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'com') THEN
        CREATE SCHEMA com;
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'drv') THEN
        CREATE SCHEMA drv;
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'rds') THEN
        CREATE SCHEMA rds;
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'rdr') THEN
        CREATE SCHEMA rdr;
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'usr') THEN
        CREATE SCHEMA usr;
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'trx') THEN
        CREATE SCHEMA trx;
    END IF;
END $EF$;

CREATE TABLE com."Bank" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "Name" character varying(100) NOT NULL,
    "Code" character varying(40) NOT NULL,
    "Type" character varying(150) NOT NULL,
    CONSTRAINT "PK_Bank" PRIMARY KEY ("Id")
);

CREATE TABLE drv."Cab" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "Name" character varying(30) NOT NULL,
    "Manufacturer" character varying(30) NOT NULL,
    "Color" character varying(20) NOT NULL,
    "Model" character varying(50) NOT NULL,
    "LicensePlateNo" character varying(20) NOT NULL,
    "Year" character varying(10) NOT NULL,
    "CabType" integer NOT NULL,
    CONSTRAINT "PK_Cab" PRIMARY KEY ("Id")
);

CREATE TABLE drv."DriverTransactionHistory" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "Reference" character varying(26) NOT NULL,
    "DriverId" bigint NOT NULL,
    "Amount" numeric NOT NULL,
    "Error" text,
    "BankAccountDetails" jsonb,
    "Status" integer NOT NULL,
    "Type" integer NOT NULL,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    "UpdatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_DriverTransactionHistory" PRIMARY KEY ("Id")
);

CREATE TABLE drv."DriverWallet" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "DriverId" bigint NOT NULL,
    "Pin" text,
    "PinResetCode" text,
    "PinResetCodeExpiry" timestamp with time zone,
    "AvailableBalance" numeric NOT NULL,
    "TotalBalance" numeric NOT NULL,
    "UpdatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_DriverWallet" PRIMARY KEY ("Id")
);

CREATE TABLE com."OutboxMessages" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "OccurredAtUtc" timestamp with time zone NOT NULL,
    "Type" text NOT NULL,
    "Content" jsonb NOT NULL,
    "ProcessedOnUtc" timestamp with time zone,
    "Error" text,
    CONSTRAINT "PK_OutboxMessages" PRIMARY KEY ("Id")
);

CREATE TABLE rds."Payment" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "Reference" character varying(26) NOT NULL,
    "Amount" numeric(20,0) NOT NULL,
    "FromWallet" numeric(20,0) NOT NULL,
    "FromRidePaymentOption" numeric(20,0) NOT NULL,
    "Method" integer NOT NULL,
    "Status" integer NOT NULL,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    "PaymentCardId" bigint,
    "Error" jsonb,
    CONSTRAINT "PK_Payment" PRIMARY KEY ("Id")
);

CREATE TABLE usr."Permission" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "Name" character varying(70) NOT NULL,
    "Code" character varying(70) NOT NULL,
    CONSTRAINT "PK_Permission" PRIMARY KEY ("Id")
);

CREATE TABLE rdr."Rider" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "FirstName" character varying(60) NOT NULL,
    "LastName" character varying(60) NOT NULL,
    "PhoneNo" character varying(15) NOT NULL,
    "Email" character varying(70) NOT NULL,
    "Gender" integer NOT NULL,
    "DateOfBirth" date,
    "ProfileImageUrl" text NOT NULL,
    "ProfileImageUrlExpiry" timestamp with time zone NOT NULL,
    "ReferralCode" text,
    "ReferredByUserId" bigint,
    "ReferredByUser" integer NOT NULL,
    "Status" integer NOT NULL,
    "Lat" double precision NOT NULL,
    "Long" double precision NOT NULL,
    "DeviceTokenId" text,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    "RefreshToken" text,
    "IsDeactivated" boolean NOT NULL,
    "IsDeleted" boolean NOT NULL,
    "IsBarred" boolean NOT NULL,
    "RefreshTokenExpiry" timestamp with time zone,
    "CurrentRideId" bigint,
    "UpdatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_Rider" PRIMARY KEY ("Id")
);

CREATE TABLE rdr."RiderWallet" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "RiderId" bigint NOT NULL,
    "Pin" text,
    "PinResetCode" text,
    "PinResetCodeExpiry" timestamp with time zone,
    "AvailableBalance" numeric NOT NULL,
    "TotalBalance" numeric NOT NULL,
    "UpdatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_RiderWallet" PRIMARY KEY ("Id")
);

CREATE TABLE usr."Role" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "Name" character varying(20) NOT NULL,
    "Code" character varying(20) NOT NULL,
    CONSTRAINT "PK_Role" PRIMARY KEY ("Id")
);

CREATE TABLE com."Settings" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "BaseFare" numeric NOT NULL,
    "RatePerKilometer" numeric NOT NULL,
    "DeliveryRatePerKilometer" numeric NOT NULL,
    "DriverCommissionFromRide" numeric NOT NULL,
    "RatePerMinute" numeric NOT NULL,
    "SupportEmails" text NOT NULL,
    "SupportPhoneNo" text NOT NULL,
    "EmergencyLines" text NOT NULL,
    "PremiumCab" integer NOT NULL,
    CONSTRAINT "PK_Settings" PRIMARY KEY ("Id")
);

CREATE TABLE trx."TransactionLog" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "Reference" character varying(26) NOT NULL,
    "Content" jsonb NOT NULL,
    "Event" text NOT NULL,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_TransactionLog" PRIMARY KEY ("Id")
);

CREATE TABLE trx."TransactionReferenceMap" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "Reference" character varying(26) NOT NULL,
    "Type" integer NOT NULL,
    CONSTRAINT "PK_TransactionReferenceMap" PRIMARY KEY ("Id")
);

CREATE TABLE drv."Driver" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "FirstName" character varying(60) NOT NULL,
    "LastName" character varying(60) NOT NULL,
    "Email" character varying(70) NOT NULL,
    "PhoneNo" character varying(15) NOT NULL,
    "ProfileImageUrl" text NOT NULL,
    "ProfileImageUrlExpiry" timestamp with time zone,
    "Gender" integer NOT NULL,
    "DateOfBirth" date,
    "IdentityValidated" boolean NOT NULL,
    "LicenseNo" character varying(40) NOT NULL,
    "LicenseImageUrl" text NOT NULL,
    "LicenseImageUrlExpiry" timestamp with time zone,
    "Lat" double precision NOT NULL,
    "Long" double precision NOT NULL,
    "Status" integer NOT NULL,
    "CabId" bigint NOT NULL,
    "CompletedTrips" integer NOT NULL,
    "RidesRated" integer NOT NULL,
    "AvgRatings" numeric NOT NULL,
    "RideRequestsDeclined" integer NOT NULL,
    "DriverService" integer NOT NULL,
    "ReferralCode" character varying(20),
    "ReferredByUserId" bigint,
    "ReferredByUser" integer NOT NULL,
    "ZeroCommissionRidesExpiry" timestamp with time zone NOT NULL,
    "DeviceTokenId" text,
    "RefreshToken" text,
    "RefreshTokenExpiry" timestamp with time zone,
    "IsDeactivated" boolean NOT NULL,
    "IsDeleted" boolean NOT NULL,
    "IsBarred" boolean NOT NULL,
    "EmailConfirmed" boolean NOT NULL,
    "CurrentRideId" bigint,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    "UpdatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_Driver" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_Driver_Cab_CabId" FOREIGN KEY ("CabId") REFERENCES drv."Cab" ("Id") ON DELETE CASCADE
);

CREATE TABLE rdr."PaymentCard" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "RiderId" bigint NOT NULL,
    "AuthorizationCode" character varying(40) NOT NULL,
    "Last4Digits" character varying(6) NOT NULL,
    "Bank" character varying(70) NOT NULL,
    "CardType" integer NOT NULL,
    "ExpiryMonth" character varying(10) NOT NULL,
    "ExpiryYear" character varying(10) NOT NULL,
    CONSTRAINT "PK_PaymentCard" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_PaymentCard_Rider_RiderId" FOREIGN KEY ("RiderId") REFERENCES rdr."Rider" ("Id") ON DELETE CASCADE
);

CREATE TABLE rdr."RiderReferrers" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "RiderId" bigint NOT NULL,
    "ReferredUserId" bigint NOT NULL,
    "ReferredUser" integer NOT NULL,
    CONSTRAINT "PK_RiderReferrers" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_RiderReferrers_Rider_RiderId" FOREIGN KEY ("RiderId") REFERENCES rdr."Rider" ("Id") ON DELETE CASCADE
);

CREATE TABLE rdr."RiderTransactionHistory" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "Reference" character varying(26) NOT NULL,
    "RiderId" bigint NOT NULL,
    "Amount" numeric NOT NULL,
    "Error" text,
    "RideId" integer,
    "Status" integer NOT NULL,
    "Type" integer NOT NULL,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    "UpdatedAtUtc" timestamp with time zone,
    CONSTRAINT "PK_RiderTransactionHistory" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_RiderTransactionHistory_Rider_RiderId" FOREIGN KEY ("RiderId") REFERENCES rdr."Rider" ("Id")
);

CREATE TABLE rdr."SavedLocation" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "RiderId" bigint NOT NULL,
    "LocationType" integer NOT NULL,
    "Coordinates" text NOT NULL,
    "Address" character varying(200) NOT NULL,
    CONSTRAINT "PK_SavedLocation" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_SavedLocation_Rider_RiderId" FOREIGN KEY ("RiderId") REFERENCES rdr."Rider" ("Id") ON DELETE CASCADE
);

CREATE TABLE usr."RolePermission" (
    "RoleId" bigint NOT NULL,
    "PermissionId" bigint NOT NULL,
    "Id" bigint NOT NULL,
    CONSTRAINT "PK_RolePermission" PRIMARY KEY ("RoleId", "PermissionId"),
    CONSTRAINT "FK_RolePermission_Permission_PermissionId" FOREIGN KEY ("PermissionId") REFERENCES usr."Permission" ("Id") ON DELETE CASCADE,
    CONSTRAINT "FK_RolePermission_Role_RoleId" FOREIGN KEY ("RoleId") REFERENCES usr."Role" ("Id") ON DELETE CASCADE
);

CREATE TABLE usr."User" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "FirstName" character varying(50) NOT NULL,
    "LastName" character varying(50) NOT NULL,
    "Email" character varying(50) NOT NULL,
    "PhoneNo" character varying(15) NOT NULL,
    "Password" text,
    "Status" integer NOT NULL,
    "RoleId" bigint NOT NULL,
    "RefreshToken" text,
    "IsDeleted" boolean NOT NULL,
    "RefreshTokenExpiry" timestamp with time zone,
    "CreatedBy" bigint,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    "UpdatedBy" bigint,
    "UpdatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_User" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_User_Role_RoleId" FOREIGN KEY ("RoleId") REFERENCES usr."Role" ("Id") ON DELETE CASCADE
);

CREATE TABLE drv."BankAccount" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "DriverId" bigint NOT NULL,
    "AccountNo" character varying(20) NOT NULL,
    "AccountName" character varying(60) NOT NULL,
    "BankId" bigint NOT NULL,
    "RecipientCode" character varying(200) NOT NULL,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_BankAccount" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_BankAccount_Bank_BankId" FOREIGN KEY ("BankId") REFERENCES com."Bank" ("Id") ON DELETE CASCADE,
    CONSTRAINT "FK_BankAccount_Driver_DriverId" FOREIGN KEY ("DriverId") REFERENCES drv."Driver" ("Id") ON DELETE CASCADE
);

CREATE TABLE drv."DriverReferrers" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "DriverId" bigint NOT NULL,
    "ReferredUserId" bigint NOT NULL,
    "ReferredUser" integer NOT NULL,
    CONSTRAINT "PK_DriverReferrers" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_DriverReferrers_Driver_DriverId" FOREIGN KEY ("DriverId") REFERENCES drv."Driver" ("Id") ON DELETE CASCADE
);

CREATE TABLE rds."Ride" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "RiderId" bigint NOT NULL,
    "DriverId" bigint,
    "HaveConversation" boolean NOT NULL,
    "Status" integer NOT NULL,
    "MusicGenre" integer NOT NULL,
    "PaymentId" bigint NOT NULL,
    "EstimatedFare" numeric(20,0) NOT NULL,
    "SourceAddress" text NOT NULL,
    "WayPointAddresses" text NOT NULL,
    "DestinationAddress" text NOT NULL,
    "SourceCordinates" text NOT NULL,
    "WaypointCordinates" text NOT NULL,
    "DestinationCordinates" text NOT NULL,
    "DistanceInMeters" double precision NOT NULL,
    "ReassignFromId" bigint,
    "Category" integer NOT NULL,
    "CancellationReason" text,
    "ReassignReason" text,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_Ride" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_Ride_Driver_DriverId" FOREIGN KEY ("DriverId") REFERENCES drv."Driver" ("Id"),
    CONSTRAINT "FK_Ride_Payment_PaymentId" FOREIGN KEY ("PaymentId") REFERENCES rds."Payment" ("Id") ON DELETE CASCADE,
    CONSTRAINT "FK_Ride_Ride_ReassignFromId" FOREIGN KEY ("ReassignFromId") REFERENCES rds."Ride" ("Id"),
    CONSTRAINT "FK_Ride_Rider_RiderId" FOREIGN KEY ("RiderId") REFERENCES rdr."Rider" ("Id")
);

CREATE TABLE rds."CallLog" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "RideId" bigint NOT NULL,
    "Recipient" integer NOT NULL,
    "Caller" integer NOT NULL,
    "DurationInSeconds" integer NOT NULL,
    "CallStartUtc" timestamp with time zone NOT NULL,
    "CallEndUtc" timestamp with time zone,
    CONSTRAINT "PK_CallLog" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_CallLog_Ride_RideId" FOREIGN KEY ("RideId") REFERENCES rds."Ride" ("Id") ON DELETE CASCADE
);

CREATE TABLE rds."Chat" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "RideId" bigint NOT NULL,
    "SenderId" bigint NOT NULL,
    "Sender" integer NOT NULL,
    "RecipientId" bigint NOT NULL,
    "Recipient" integer NOT NULL,
    "Message" character varying(200) NOT NULL,
    "IsRead" boolean NOT NULL,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_Chat" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_Chat_Ride_RideId" FOREIGN KEY ("RideId") REFERENCES rds."Ride" ("Id") ON DELETE CASCADE
);

CREATE TABLE rds."Ratings" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "RideId" bigint NOT NULL,
    "Rating" integer NOT NULL,
    "Feedback" character varying(120),
    CONSTRAINT "PK_Ratings" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_Ratings_Ride_RideId" FOREIGN KEY ("RideId") REFERENCES rds."Ride" ("Id") ON DELETE CASCADE
);

CREATE TABLE rds."RideLog" (
    "Id" bigint GENERATED BY DEFAULT AS IDENTITY,
    "RideId" bigint NOT NULL,
    "Status" integer NOT NULL,
    "CreatedAtUtc" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_RideLog" PRIMARY KEY ("Id"),
    CONSTRAINT "FK_RideLog_Ride_RideId" FOREIGN KEY ("RideId") REFERENCES rds."Ride" ("Id") ON DELETE CASCADE
);

CREATE INDEX "IX_BankAccount_BankId" ON drv."BankAccount" ("BankId");

CREATE INDEX "IX_BankAccount_DriverId" ON drv."BankAccount" ("DriverId");

CREATE INDEX "IX_CallLog_RideId" ON rds."CallLog" ("RideId");

CREATE INDEX "IX_Chat_RideId" ON rds."Chat" ("RideId");

CREATE INDEX "IX_Driver_CabId" ON drv."Driver" ("CabId");

CREATE INDEX "IX_Driver_Email" ON drv."Driver" ("Email");

CREATE INDEX "IX_Driver_PhoneNo" ON drv."Driver" ("PhoneNo");

CREATE UNIQUE INDEX "IX_Driver_ReferralCode" ON drv."Driver" ("ReferralCode");

CREATE INDEX "IX_DriverReferrers_DriverId" ON drv."DriverReferrers" ("DriverId");

CREATE UNIQUE INDEX "IX_DriverTransactionHistory_Reference" ON drv."DriverTransactionHistory" ("Reference");

CREATE INDEX "IX_PaymentCard_RiderId" ON rdr."PaymentCard" ("RiderId");

CREATE INDEX "IX_Ratings_RideId" ON rds."Ratings" ("RideId");

CREATE INDEX "IX_Ride_DriverId" ON rds."Ride" ("DriverId");

CREATE INDEX "IX_Ride_PaymentId" ON rds."Ride" ("PaymentId");

CREATE INDEX "IX_Ride_ReassignFromId" ON rds."Ride" ("ReassignFromId");

CREATE INDEX "IX_Ride_RiderId" ON rds."Ride" ("RiderId");

CREATE INDEX "IX_RideLog_RideId" ON rds."RideLog" ("RideId");

CREATE INDEX "IX_Rider_Email" ON rdr."Rider" ("Email");

CREATE INDEX "IX_Rider_PhoneNo" ON rdr."Rider" ("PhoneNo");

CREATE UNIQUE INDEX "IX_Rider_ReferralCode" ON rdr."Rider" ("ReferralCode");

CREATE INDEX "IX_RiderReferrers_RiderId" ON rdr."RiderReferrers" ("RiderId");

CREATE UNIQUE INDEX "IX_RiderTransactionHistory_Reference" ON rdr."RiderTransactionHistory" ("Reference");

CREATE INDEX "IX_RiderTransactionHistory_RiderId" ON rdr."RiderTransactionHistory" ("RiderId");

CREATE INDEX "IX_RolePermission_PermissionId" ON usr."RolePermission" ("PermissionId");

CREATE INDEX "IX_SavedLocation_RiderId" ON rdr."SavedLocation" ("RiderId");

CREATE INDEX "IX_User_Email" ON usr."User" ("Email");

CREATE INDEX "IX_User_PhoneNo" ON usr."User" ("PhoneNo");

CREATE INDEX "IX_User_RoleId" ON usr."User" ("RoleId");

INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
VALUES ('20250113132203__init_', '8.0.8');

COMMIT;

